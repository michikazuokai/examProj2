

# **ğŸ“˜ è©¦é¨“ãƒ‡ãƒ¼ã‚¿ã€Œå®Œå…¨å†ãƒ­ãƒ¼ãƒ‰ã€ãƒ†ã‚¹ãƒˆæ‰‹é †ï¼ˆç ´å£Šã‚ã‚Š / Phase3é‹ç”¨ï¼‰**



## **ç›®çš„**

Subject / Exam / Question / æ¡ç‚¹ç³»ï¼ˆSEV/SE/Adjustï¼‰ã‚’ **ä¸€åº¦ã‚¯ãƒªã‚¢ã—ã¦ã€ã‚¼ãƒ­ã‹ã‚‰å†ç”Ÿæˆ**ã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

Phase3ï¼ˆSubjectã« fsyear/term ã‚’æŒã¡ã€Examã¯ subject+versionï¼‰ã«åˆã‚ã›ãŸé‹ç”¨ã€‚

------

## **å‰æ**

- å¯¾è±¡ï¼šsubjectNo=<span style="color:red"><ç§‘ç›®ã‚³ãƒ¼ãƒ‰></span>, fsyear=2025ï¼ˆå¿…è¦ã«å¿œã˜ã¦èª­ã¿æ›¿ãˆï¼‰
- JSONï¼š/Volumes/NBPlan/TTC/examtools/work/answers_<subjectNo>.json
- YAMLï¼šexam2/data/studentVersion.yaml
- **é‡è¦**ï¼šã“ã®æ‰‹é †ã¯ã€Œç ´å£Šã‚ã‚Šã€ã§ã™ã€‚å¯¾è±¡ subjectNo/fsyear ã‚’å¿…ãšç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚


------

## **å¤‰æ•°ï¼ˆèª­ã¿æ›¿ãˆç”¨ï¼‰**


- <SUBJECT_NO> = <span style="color:red"><ç§‘ç›®ã‚³ãƒ¼ãƒ‰></span>
- <FSYEAR> = 2025


------

# **âœ… æ‰‹é †Bï¼šå®Œå…¨å†ãƒ­ãƒ¼ãƒ‰ï¼ˆç ´å£Šã‚ã‚Šï¼‰**

------

## **0) äº‹å‰å®‰å…¨ç¢ºèªï¼ˆçµ¶å¯¾ã‚„ã‚‹ï¼‰**

### **0-1. å¯¾è±¡ Subject ãŒæ­£ã—ã„ã‹ç¢ºèª**

```
python manage.py shell -c "from exam2.models import Subject; s=Subject.objects.get(subjectNo='<ç§‘ç›®ã‚³ãƒ¼ãƒ‰>',fsyear=2025); print(s.id,s.subjectNo,s.fsyear,s.term,s.nenji,s.name)"
```

### **0-2. ç¾åœ¨ã®ä»¶æ•°ï¼ˆæ¶ˆãˆã‚‹é‡ã®è¦‹ç©ï¼‰**

```
python manage.py shell -c "
from exam2.models import Subject,Exam,Question,StudentExam,StudentExamVersion,ExamAdjust
s=Subject.objects.get(subjectNo='<ç§‘ç›®ã‚³ãƒ¼ãƒ‰>',fsyear=2025)
ex=Exam.objects.filter(subject=s)
print('Exam=',ex.count())
print('Question=',Question.objects.filter(exam__in=ex).count())
print('SEV=',StudentExamVersion.objects.filter(exam__in=ex).count())
print('SE=',StudentExam.objects.filter(exam__in=ex).count())
print('Adjust=',ExamAdjust.objects.filter(exam__in=ex).count())
"
```



------

## **1) clearï¼ˆç ´å£Šï¼‰**



### **1-1. clear_subject_data å®Ÿè¡Œ**



```
python manage.py clear_subject_data <ç§‘ç›®ã‚³ãƒ¼ãƒ‰>
```

ã“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§subjectä»¥å¤–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®é–¢é€£ã™ã‚‹ç§‘ç›®ã‚³ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã™ã¹ã¦å‰Šé™¤ã™ã‚‹ã€‚

**å¯¾è±¡ãƒ†ãƒ¼ãƒ–ãƒ«**:

- `StudentExam`: å­¦ç”Ÿã®å•é¡Œã”ã¨ã®è§£ç­”ãƒ‡ãƒ¼ã‚¿ 
- `ExamAdjust`: å­¦ç”Ÿã”ã¨ã®æœ€çµ‚çš„ãªå¾—ç‚¹èª¿æ•´ãƒ‡ãƒ¼ã‚¿ 

**çµã‚Šè¾¼ã¿æ¡ä»¶**:

- æŒ‡å®šã—ãŸ **ç§‘ç›®ã‚³ãƒ¼ãƒ‰ï¼ˆ`subjectNo`ï¼‰** ã‹ã¤ **å¹´åº¦ï¼ˆ`fsyear`ï¼‰** ã«ä¸€è‡´ã™ã‚‹ã‚‚ã®ã®ã¿ãŒå¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚

| **é …ç›®**                         | **çŠ¶æ…‹**                                  |
| -------------------------------- | ----------------------------------------- |
| **è©¦é¨“å•é¡Œ (`Question`)**        | ãã®ã¾ã¾æ®‹ã‚Šã¾ã™ã€‚                        |
| **å­¦ç”Ÿã®è§£ç­”è¡Œ (`StudentExam`)** | è¡Œè‡ªä½“ã¯æ®‹ã‚Šã¾ã™ãŒã€ç‚¹æ•°ãŒ 0 ã«ãªã‚Šã¾ã™ã€‚ |
| **è©¦é¨“ã®æ çµ„ã¿ (`Exam`)**        | ãã®ã¾ã¾æ®‹ã‚Šã¾ã™ã€‚                        |
| **ç§‘ç›®ãƒã‚¹ã‚¿ãƒ¼ (`Subject`)**     | ãã®ã¾ã¾æ®‹ã‚Šã¾ã™ã€‚                        |

### **1-2. clear å¾Œã®ç¢ºèªï¼ˆPhase3ã®æœŸå¾…å€¤ï¼‰**



Phase3é‹ç”¨ã§ã¯ **Subjectã¯æ®‹ã—ã€Examä»¥ä¸‹ãŒ0** ã«ãªã£ã¦ã„ã‚‹ã®ãŒæ­£ã—ã„ã§ã™ã€‚

```
python manage.py shell -c "
from exam2.models import Subject,Exam,Question,StudentExam,StudentExamVersion,ExamAdjust
s=Subject.objects.get(subjectNo='<ç§‘ç›®ã‚³ãƒ¼ãƒ‰>',fsyear=2025)
ex=Exam.objects.filter(subject=s)
print('Subject=',1)
print('Exam=',ex.count())
print('Question=',Question.objects.filter(exam__in=ex).count())
print('SEV=',StudentExamVersion.objects.filter(exam__in=ex).count())
print('SE=',StudentExam.objects.filter(exam__in=ex).count())
print('Adjust=',ExamAdjust.objects.filter(exam__in=ex).count())
"
```

âœ… æœŸå¾…å€¤ï¼š



- Subject=1
- Exam=0
- Question=0
- SEV=0
- SE=0
- Adjust=0



> è£œè¶³ï¼šã‚ãªãŸã®å®Ÿè¡Œçµæœã§ã€ŒSubjectãŒ1ä»¶æ®‹ã‚‹ã€ã¯ **æ­£å¸¸**ã§ã™ï¼ˆPhase3ã®è¨­è¨ˆã©ãŠã‚Šï¼‰ã€‚



------



## **2) load_subject_baseï¼ˆSubject/Examä½œæˆï¼‰**



### **2-1. å®Ÿè¡Œ**



```
python manage.py load_subject_base <ç§‘ç›®ã‚³ãƒ¼ãƒ‰>
```



### **2-2. æ¤œè¨¼ï¼ˆExamãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä½œã‚‰ã‚Œã¦ã„ã‚‹ã‹ï¼‰**



```
python manage.py shell -c "
from exam2.models import Subject,Exam
s=Subject.objects.get(subjectNo='<ç§‘ç›®ã‚³ãƒ¼ãƒ‰>',fsyear=2025)
print('Subject OK:',s.id,s.term,s.nenji,s.name)
print('Exam versions:',list(Exam.objects.filter(subject=s).order_by('version').values_list('version',flat=True)))
"
```

âœ… æœŸå¾…ï¼š['A','B'] ãªã©ãŒå‡ºã‚‹



------





## **3) load_questionsï¼ˆQuestionå†ä½œæˆï¼‰**







### **3-1. å®Ÿè¡Œï¼ˆç ´å£Šãƒ†ã‚¹ãƒˆãªã®ã§æ¯å›åŒã˜çµæœã«ã™ã‚‹ãŸã‚ clear æ¨å¥¨ï¼‰**



```
python manage.py load_questions <ç§‘ç›®ã‚³ãƒ¼ãƒ‰> --fsyear 2025 --clear-existing --fix-qno
```



### **3-2. æ¤œè¨¼ï¼ˆversionåˆ¥ Question ä»¶æ•°ï¼‰**



```
python manage.py shell -c "
from exam2.models import Subject,Exam,Question
s=Subject.objects.get(subjectNo='<ç§‘ç›®ã‚³ãƒ¼ãƒ‰>',fsyear=2025)
for e in Exam.objects.filter(subject=s).order_by('version'):
    print(e.version, 'Q=', Question.objects.filter(exam=e).count())
"
```

âœ… æœŸå¾…ï¼šA/Bã§åŒç¨‹åº¦ã®ä»¶æ•°ãŒå‡ºã‚‹



------



## **4) load_student_exam_versionï¼ˆå‰²å½“ï¼‰**



### **4-1. dry-runï¼ˆå¿…é ˆï¼‰**



```
python manage.py load_student_exam_version <ç§‘ç›®ã‚³ãƒ¼ãƒ‰> --fsyear 2025 --dry-run
```



### **4-2. æœ¬å®Ÿè¡Œï¼ˆæ—¢å­˜ã‚’æ¶ˆã—ã¦ä½œã‚Šç›´ã—ï¼‰**



```
python manage.py load_student_exam_version <ç§‘ç›®ã‚³ãƒ¼ãƒ‰> --fsyear 2025 --clear-existing
```



### **4-3. æ¤œè¨¼ï¼ˆversionåˆ¥å‰²å½“æ•°ï¼‰**



```
python manage.py shell -c "
from exam2.models import Subject,Exam,StudentExamVersion
s=Subject.objects.get(subjectNo='<ç§‘ç›®ã‚³ãƒ¼ãƒ‰>',fsyear=2025)
for e in Exam.objects.filter(subject=s).order_by('version'):
    print(e.version,'SEV=',StudentExamVersion.objects.filter(exam=e).count())
"
```



------





## **5) load_student_examï¼ˆæ¡ç‚¹è¡Œã®ç”Ÿæˆï¼šTF=0,hosei=0ï¼‰**







### **5-1. dry-runï¼ˆä»¶æ•°è¦‹ç©ï¼‰**



```
python manage.py load_student_exam <ç§‘ç›®ã‚³ãƒ¼ãƒ‰> --fsyear 2025 --dry-run
```



### **5-2. æœ¬å®Ÿè¡Œ**



```
python manage.py load_student_exam <ç§‘ç›®ã‚³ãƒ¼ãƒ‰> --fsyear 2025 --batch-size 2000
```



### **5-3. æ¤œè¨¼ï¼ˆç·ä»¶æ•°ï¼‰**



```
python manage.py shell -c "
from exam2.models import Subject,Exam,StudentExam
s=Subject.objects.get(subjectNo='<ç§‘ç›®ã‚³ãƒ¼ãƒ‰>',fsyear=2025)
ex=Exam.objects.filter(subject=s)
print('StudentExam total=',StudentExam.objects.filter(exam__in=ex).count())
"
```



------





## **6) load_exam_adjustï¼ˆè£œæ­£è¡Œã®ç”Ÿæˆï¼šadjust=0ï¼‰**







### **6-1. dry-run**



```
python manage.py load_exam_adjust <ç§‘ç›®ã‚³ãƒ¼ãƒ‰> --fsyear 2025 --dry-run
```



### **6-2. æœ¬å®Ÿè¡Œ**



```
python manage.py load_exam_adjust <ç§‘ç›®ã‚³ãƒ¼ãƒ‰> --fsyear 2025 --batch-size 2000
```



### **6-3. æ¤œè¨¼ï¼ˆç·ä»¶æ•°ï¼‰**



```
python manage.py shell -c "
from exam2.models import Subject,Exam,ExamAdjust
s=Subject.objects.get(subjectNo='<ç§‘ç›®ã‚³ãƒ¼ãƒ‰>',fsyear=2025)
ex=Exam.objects.filter(subject=s)
print('ExamAdjust total=',ExamAdjust.objects.filter(exam__in=ex).count())
"
```



------





# **âœ… æœ€çµ‚ãƒã‚§ãƒƒã‚¯ï¼ˆUI/APIè¦³ç‚¹ï¼‰**





- index ã§ subject ã‚’é¸ã¶ â†’ å­¦ç”Ÿä¸€è¦§ãŒå‡ºã‚‹
- å­¦ç”Ÿã‚’é–‹ãï¼ˆæ¡ç‚¹ç”»é¢ï¼‰ â†’ ã‚¿ã‚¤ãƒˆãƒ«ã« **version(A/B)** ãŒè¡¨ç¤ºã•ã‚Œã‚‹
- è¡Œä¸€æ‹¬ ON/OFF â†’ /api/student-exams/bulk_update/ ãŒ **500ã«ãªã‚‰ãªã„**
- cancel â†’ å…ƒã«æˆ»ã‚‹ï¼ˆbulk_update ã§DBã‚‚æˆ»ã‚‹ï¼‰





------





# **âš ï¸ é‡è¦ãƒ¡ãƒ¢ï¼ˆclear_subject_data ã®ä»•æ§˜å›ºå®šï¼‰**





Phase3é‹ç”¨ã§ã¯ã€**Subjectã¯æ®‹ã—ã¦ Examä»¥ä¸‹ã‚’æ¶ˆã™**ã®ãŒå®‰å…¨ã§ã™ã€‚

ã‚ãªãŸã®ã‚³ãƒãƒ³ãƒ‰å‡ºåŠ›ã‚‚ã€ŒSubjectè‡ªä½“ã¯å‰Šé™¤ã—ã¾ã›ã‚“ã€‚Examä»¥ä¸‹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã€ã«ãªã£ã¦ã„ã‚‹ã®ã§ã€ãã®æ–¹é‡ã§å›ºå®šã—ã¦ãã ã•ã„ã€‚



------





# **ğŸ§¯ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒˆ**







## **1)** 

## **YAML ã« fsyear=2025 ã®ãƒ–ãƒ­ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“**





åŸå› ï¼šYAML å´ã®ã‚­ãƒ¼ãŒ 2025: ã§ã‚ã£ã¦ã‚‚ã€èª­ã¿è¾¼ã¿çµæœã®ã‚­ãƒ¼å‹ï¼ˆint/strï¼‰ãŒæƒ³å®šã¨é•ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

ã‚ãªãŸã®æç¤ºã§ã¯ YAML ã¯ï¼š

```
2025:
  1:
    A:
      - 25367001
```

â†’ load_student_exam_version.py å´ã§ str(fsyear) ã¨ int ä¸¡æ–¹å¯¾å¿œã—ã¦ã„ã‚‹ãªã‚‰é€šå¸¸ã¯é€šã‚Šã¾ã™ã€‚

ãã‚Œã§ã‚‚å‡ºã‚‹å ´åˆã¯ã€ŒYAMLãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ãƒ‘ã‚¹ãŒé•ã†ã€å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ï¼ˆã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‘ã‚¹ã¨å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç…§åˆï¼‰ã€‚





## **2) clearã—ãŸã®ã«ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã‚‹**





- subjectNo ã ã‘ã§æ¶ˆã—ã¦ã„ã¦ã€fsyearé•ã„ ã® Subject ãŒæ··åœ¨ã—ã¦ã„ã‚‹å¯èƒ½æ€§

  â†’ å¿…ãš subjectNo,fsyear ã§ç‰¹å®šã—ã¦ç¢ºèªã™ã‚‹ï¼ˆ0-1ã®ã‚³ãƒãƒ³ãƒ‰ï¼‰





------



å¿…è¦ãªã‚‰ã€ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ **ãƒã‚§ãƒƒã‚¯æ¬„ä»˜ãï¼ˆâ–¡ï¼‰**ã«ã—ã¦ã€Œå®Ÿæ–½è¨˜éŒ²ã‚’æ›¸ãè¾¼ã‚ã‚‹ç‰ˆã€ã«ã‚‚ã§ãã¾ã™ã€‚